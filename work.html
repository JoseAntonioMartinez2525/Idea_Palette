<html>

<head>
  <title>Lienzo</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script> 
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="./js/rect.js"></script>
  <script src="./js/linea.js"></script>
  <script src="./js/elipse.js"></script>
  <script src="./js/texto.js"></script>
  <link rel="stylesheet" href="./css/main.css">
  <script src="https://kit.fontawesome.com/e72e299160.js" crossorigin="anonymous"></script>
</head>

<body>
<div class="sidebar">
  <div>
    <div class="logo">游꿛 Idea Palette</div>
    <i class="fa-regular fa-circle-user"></i>
    <ul>
      <li><a href="home.html">Mis Proyectos</a></li>
      <li><a href="landing_page.html">Cerrar sesi칩n</a></li>
    </ul>
  </div>
</div>
  <div class="mr-4">
    <ul id="option-list">
      <li class="list-group-item">
        <button onclick="selectTool('rect')">
          <img src="img/software-shape-rectangle_98272.png" id="rect-tool">
          Rect치ngulo
        </button>
      </li>
      <li class="list-group-item">
        <button onclick="selectTool('circle')">
          <img src="img/ellipse_icon-icons.com_54003.png" id="elipse-tool">Elipse
        </button>
      </li>
      <li class="list-group-item">
        <button onclick="selectTool('line')">
          <img src="img/straight-horizontal-line_icon-icons.com_74237.png" id="line-tool">L칤nea
        </button>
      </li>
      <li class="list-group-item">
        <button>
          <input type="checkbox" id="fill-color" onchange="generarTexto()"><label for="fill-color">Relleno</label>
        </button>
      </li>
      <li class="list-group-item">
        <button onclick="crearTexto('text')">
          <img src="img/rename_inputtext_thetext_1544.png" id="text-tool"">Texto
        </button>
      </li>
      <li class="list-group-item">
        <button onclick="nuevo()">
          <img src="img/1491254405-plusaddmoredetail_82972.png" id="nuevo">
        Nuevo</button>
      </li>
      <li class="list-group-item">     
    <button onclick="guardar()">
      <img src="img/save.png">
      Guardar</button>
      </li>

    </ul>
  </div>
  <div id="textoGenerado"></div>

  <script>
    let startX, startY;
    let endX, endY;
    let dragging = false;
    let selectedTool;
    let rectanglesArray = [];
    let linesArray = []; // Array para almacenar las l칤neas dibujadas
    let ellipsesArray = []; // Array para almacenar las elipses dibujadas
    let textosArray = [];
    let inputText;
    let selectedColor = 0;

      window.addEventListener('DOMContentLoaded', (event) => {
          updateParamList();
        });
    function selectTool(tool) {
      selectedTool = tool;
      
    }

    function setup() {
      let canvas = createCanvas(650, 500);
      canvas.parent("canvas-container");

      let rectTool = document.getElementById("rect-tool");
      rectTool.addEventListener("click", function () {
        selectTool('rect');
      });

      let lineTool = document.getElementById("line-tool");
      lineTool.addEventListener("click", function () {
        selectTool('line');
      });

      let elipseTool = document.getElementById("elipse-tool");
      elipseTool.addEventListener("click", function () {
        selectTool('circle');
      });
    }

    function draw() {
      background(220);

      // Dibujar las l칤neas
      for (let line of linesArray) {
        line.display();
      }

      // Dibujar los rect치ngulos
      for (let rect of rectanglesArray) {
        rect.display();
      }

      // Dibujar las elipses
      for (let ellipse of ellipsesArray) {
        ellipse.display();
      }

      // Dibujar los textos
      for (let texto of textosArray) {
        texto.display();
      }

      // Dibujar la l칤nea actual si se est치 arrastrando
      if (dragging && selectedTool === "line") {
        stroke(0);
        line(startX, startY, mouseX, mouseY);
      }

      // Dibujar el rect치ngulo actual si se est치 arrastrando
      if (dragging && selectedTool === "rect") {
        noFill();
        stroke(0);
        rect(startX, startY, mouseX - startX, mouseY - startY);
      }

      // Dibujar la elipse actual si se est치 arrastrando
      if (dragging && selectedTool === "circle") {
        noFill();
        stroke(0);
        let radius = dist(startX, startY, mouseX, mouseY);
        let diameter = radius * 2;
        ellipse(startX, startY, diameter, diameter);
      }

        // Dibujar el texto actual si se est치 arrastrando
      if (dragging && selectedTool === "text") {
        noStroke();
        fill(selectedColor);
        textSize(20);
        text(currentText, startX, startY);
      }

      
    }

    function mouseReleased() {
      endX = mouseX;
      endY = mouseY;
      dragging = false;

      if (selectedTool === "rect") {
        let width = endX - startX;
        let height = endY - startY;

        if (width !== 0 && height !== 0) {
          let newRect = new CustomRectangle(startX, startY, width, height, selectedColor);
          rectanglesArray.push(newRect);
        }
      }

      if (selectedTool === "line") {
        let newLine = new CustomLine(startX, startY, endX, endY, selectedColor);
        linesArray.push(newLine);
      }

      if (selectedTool === "circle") {
        let radius = dist(startX, startY, endX, endY);
        let diameter = radius * 2;
        let newEllipse = new CustomEllipse(startX, startY, diameter, diameter, selectedColor);
        ellipsesArray.push(newEllipse);
      }

      if (selectedTool === "text") {
        let newTexto = new CustomTexto(currentText, startX, startY, selectedColor);
        textosArray.push(newTexto);
        currentText = ""; // Reiniciar el texto actual
      }

      updateParamList();
    }

    function mousePressed() {
      startX = mouseX;
      startY = mouseY;
      dragging = true;
    }

    function generarTexto() {
      var checkbox = document.getElementById("fill-color");
      var elemento = document.getElementById("textoGenerado");

      if (checkbox.checked) {
        var labelColor = document.createElement("label");
        labelColor.textContent = "Escoge el Color ";

        var inputColor = document.createElement("input");
        inputColor.type = "color";

        labelColor.style.marginRight = "10px";

        inputColor.addEventListener("input", function () {
          selectedColor = inputColor.value;
          //updateStrokeColor();
        });

        elemento.appendChild(labelColor);
        elemento.appendChild(inputColor);
      } else {
        elemento.innerHTML = "";
        selectedColor = 0;
        //updateStrokeColor();
      }
    }

    function updateStrokeColor() {
      for (let rect of rectanglesArray) {
        rect.strokeColor = selectedColor;
      }

      for (let line of linesArray) {
        line.strokeColor = selectedColor;
      }

      for (let ellipse of ellipsesArray) {
        ellipse.strokeColor = selectedColor;
      }

      for (let texto of textosArray) {
        texto.strokeColor = selectedColor;
      }
    }

    function guardar() {
      let contenido = JSON.stringify({
        rectangles: rectanglesArray,
        lines: linesArray,
        ellipses: ellipsesArray,
        texts: textosArray
      });

      // Datos par치metros de la figura guadrada

      console.log(contenido);
        fetch("/guardar-datos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: contenido
      })
        .then(response => {
          if (response.ok) {
            console.log("Datos guardados exitosamente");
          } else {
            console.log("Error al guardar los datos");
          }
        })
        .catch(error => {
          console.log("Error en la solicitud:", error);
        });

      
    }

    function nuevo() {
      rectanglesArray = [];
      linesArray = [];
      ellipsesArray = [];
      textosArray = [];
    }

  function crearTexto() {
    selectedTool = "text"; // Establecer la herramienta seleccionada en "text"
    currentText = ""; // Reiniciar el texto actual al crear uno nuevo

    let isDragging = false;
    let offset = { x: 0, y: 0 };


    function handleMouseUp(event) {
      endX = event.clientX;
      endY = event.clientY;

      if (endX !== startX && endY !== startY) {
        let texto = textarea.value;
        let x = endX;
        let y = endY;
        let newTexto = new CustomTexto(texto, x, y, selectedColor);
        textosArray.push(newTexto);
      }

      isDragging = false;
      textarea.parentNode.removeChild(textarea);
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    }

        function handleMouseDown(event) {
      startX = event.clientX;
      startY = event.clientY;

      textarea.style.left = startX + "px";
      textarea.style.top = startY + "px";

      isDragging = true;
          offset.x = event.clientX - parseInt(textarea.style.left);
          offset.y = event.clientY - parseInt(textarea.style.top);

      document.addEventListener("mousemove", handleMouseMove);
      document.addEventListener("mouseup", handleMouseUp);
    }

   function handleMouseMove(event) {
      if (isDragging) {
        let x = event.clientX - offset.x;
        let y = event.clientY - offset.y;
        textarea.style.left = x + "px";
        textarea.style.top = y + "px";
      }
    }

    let textarea = document.createElement("textarea");
    textarea.style.position = "absolute"; // Establecer la posici칩n como "absolute"
    textarea.style.left = "0";
    textarea.style.top = "0";
    textarea.style.resize = "none";
    textarea.style.border = "1px solid black";
    textarea.style.background = "transparent";
    textarea.style.color = "#000";

    let canvasContainer = document.getElementById("canvas-container");
    canvasContainer.appendChild(textarea);
    textarea.focus();
    textarea.addEventListener("mousedown", handleMouseDown);
  }

  function updateParamList() {
      let paramList = document.getElementById("param-list");
      paramList.innerHTML = ""; // Limpiar la lista antes de agregar nuevos elementos

      // Obtener la figura seleccionada
      let selectedShape = null;

      if (selectedTool === "rect" && rectanglesArray.length > 0) {
        selectedShape = rectanglesArray[rectanglesArray.length - 1];
      } else if (selectedTool === "line" && linesArray.length > 0) {
        selectedShape = linesArray[linesArray.length - 1];
      } else if (selectedTool === "circle" && ellipsesArray.length > 0) {
        selectedShape = ellipsesArray[ellipsesArray.length - 1];
      } else if (selectedTool === "text" && textosArray.length > 0) {
        selectedShape = textosArray[textosArray.length - 1];
      }

      // Agregar los par치metros de la figura seleccionada a la lista
      if (selectedShape) {
        let params = [
          { name: "x", value: selectedShape.x },
          { name: "y", value: selectedShape.y },
          { name: "width", value: selectedShape.width },
          { name: "height", value: selectedShape.height },
          { name: "strokeColor", value: selectedShape.strokeColor },
          { name: "color", value: selectedShape.color }
        ];

        for (let param of params) {
          let listItem = document.createElement("li");
          listItem.textContent = `${param.name}: ${param.value}`;
          paramList.appendChild(listItem);
        }
      }
    }

  function getProyectos() {
    // Obtiene los proyectos guardados del almacenamiento local
    const proyectosGuardados = JSON.parse(localStorage.getItem("proyectos"));

  }

  function enviarProyectos(proyectos) {
      // Dispara un evento personalizado llamado "proyectosActualizados"
      // y pasa los proyectos como detalle del evento
      const event = new CustomEvent("proyectosActualizados", { detail: proyectos });
      window.dispatchEvent(event);
    }


  </script>


  <div id="canvas-container"></div>

  <div id="sidebar">
   <b><label>Par치metros</label></b> 
    <ul id="param-list"></ul>
  </div>

</body>

</html>